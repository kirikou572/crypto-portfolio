<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Crypto</title>
  <!-- Bootstrap + Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-dark text-white">

<div class="container py-4">
  <h1 class="text-info mb-4">Votre portefeuille crypto</h1>

  <!-- Formulaire d'ajout -->
  <form id="cryptoForm" class="row g-3 bg-secondary p-3 rounded">
    <div class="col-md-4">
      <input type="text" id="ticker" class="form-control" placeholder="Ex: BTC" required />
    </div>
    <div class="col-md-4">
      <input type="number" step="any" id="amount" class="form-control" placeholder="QuantitÃ©" required />
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-info w-100">Ajouter la crypto</button>
    </div>
  </form>

  <!-- Message -->
  <div id="message" class="mt-3"></div>

  <!-- Tableau -->
  <table class="table table-dark table-bordered table-striped mt-4">
    <thead class="table-light">
      <tr>
        <th>Ticker</th>
        <th>QuantitÃ©</th>
        <th>Prix ($)</th>
        <th>Total ($)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="portfolioTable"></tbody>
  </table>

  <!-- Total global -->
  <div class="h5 mt-3 text-success" id="totalSum">Total du portefeuille : $0.00</div>

  <!-- Graphique -->
  <div class="my-4">
    <canvas id="portfolioChart"></canvas>
  </div>

  <button class="btn btn-danger mt-3" onclick="logout()">Se dÃ©connecter</button>
</div>

<script>
  const API_URL = "https://crypto-portfolio-production-b673.up.railway.app/portfolio";
  const token = localStorage.getItem("token");

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "index.html";
  }

  document.getElementById("cryptoForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const ticker = document.getElementById("ticker").value.trim().toUpperCase();
    const amount = parseFloat(document.getElementById("amount").value);
    const messageEl = document.getElementById("message");

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ ticker, amount })
      });

      const data = await res.json();
      if (res.ok) {
        messageEl.textContent = "Crypto ajoutÃ©e.";
        messageEl.className = "text-success";
        document.getElementById("cryptoForm").reset();
        fetchPortfolio();
      } else {
        messageEl.textContent = data.message || "Erreur.";
        messageEl.className = "text-danger";
      }
    } catch {
      messageEl.textContent = "Erreur rÃ©seau.";
      messageEl.className = "text-danger";
    }
  });

  async function fetchPortfolio() {
    const res = await fetch(API_URL, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();
    if (res.ok) renderPortfolio(data.portfolio);
  }

  async function modifyCrypto(ticker, amount) {
    await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ ticker, amount })
    });
    fetchPortfolio();
  }

  async function deleteCrypto(ticker) {
    if (!confirm(`Supprimer toutes les entrÃ©es de ${ticker} ?`)) return;
    await fetch(`${API_URL}/${ticker}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` }
    });
    fetchPortfolio();
  }

  function renderPortfolio(portfolio) {
    const table = document.getElementById("portfolioTable");
    const totalSum = document.getElementById("totalSum");
    table.innerHTML = "";

    let merged = {};
    let total = 0;

    portfolio.forEach(item => {
      const key = item.ticker.toUpperCase();
      if (!merged[key]) {
        merged[key] = { ticker: key, amount: 0, total: 0, price: item.price };
      }
      merged[key].amount += item.amount;
      merged[key].total += item.total;
    });

    const chartLabels = [];
    const chartData = [];

    Object.values(merged).forEach(item => {
      total += item.total;
      chartLabels.push(item.ticker);
      chartData.push(item.total);

      table.innerHTML += `
        <tr>
          <td>${item.ticker}</td>
          <td>${item.amount.toFixed(6)}</td>
          <td>$${item.price.toFixed(2)}</td>
          <td>$${item.total.toFixed(2)}</td>
          <td>
            <button class="btn btn-sm btn-success me-1" onclick="modifyCrypto('${item.ticker}', 1)">+ Ajouter</button>
            <button class="btn btn-sm btn-warning me-1" onclick="modifyCrypto('${item.ticker}', -1)">- Retirer</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCrypto('${item.ticker}')">ðŸ—‘ Supprimer</button>
          </td>
        </tr>
      `;
    });

    totalSum.textContent = `Total du portefeuille : $${total.toFixed(2)}`;
    updateChart(chartLabels, chartData);
  }

  let pieChart;
  function updateChart(labels, data) {
    const ctx = document.getElementById("portfolioChart").getContext("2d");
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [{
          label: "RÃ©partition portefeuille",
          data,
          backgroundColor: ["#2196f3", "#4caf50", "#ff9800", "#f44336", "#9c27b0", "#00bcd4", "#ffc107"]
        }]
      },
      options: {
        plugins: {
          legend: { labels: { color: "white" } }
        }
      }
    });
  }

  window.onload = fetchPortfolio;
</script>

</body>
</html>
