<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Crypto Portfolio</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #121212; color: #fff; font-family: Arial, sans-serif; padding: 2rem; }
    h1, h2 { color: #00bcd4; }
    .controls { margin-bottom: 1rem; }
    select, button { margin-right: 1rem; }
    form, table, canvas, .message { margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #444; }
    th { background-color: #1e1e1e; }
    .message.error { color: #f44336; }
    .message { color: #4caf50; }
    button.logout { background: #f44336; color: #fff; }
  </style>
</head>
<body>
  <h1>Dashboard Crypto Portfolio</h1>

  <div class="controls">
    <label>Devise :
      <select id="currencySelect">
        <option value="EUR" selected>€</option>
        <option value="USD">$</option>
      </select>
    </label>
    <button class="logout" onclick="logout()">Se déconnecter</button>
  </div>

  <h2>Ajouter une crypto</h2>
  <form id="cryptoForm">
    <input type="text" id="ticker" placeholder="Ex : BTC" required />
    <input type="number" step="any" id="amount" placeholder="Quantité" required />
    <button type="submit">Ajouter</button>
  </form>

  <div class="message" id="message"></div>

  <h2>Votre portefeuille</h2>
  <table id="portfolioTable">
    <thead>
      <tr>
        <th>Ticker</th><th>Quantité</th><th>Prix (<span id="currencyLabel">€</span>)</th><th>Total (<span id="currencyLabel2">€</span>)</th><th>Action</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="5">Chargement...</td></tr></tbody>
  </table>

  <h2>Graphique</h2>
  <canvas id="portfolioChart" width="400" height="200"></canvas>

  <script>
    const backendUrl = "https://crypto-portfolio-production-b673.up.railway.app";
    const token = localStorage.getItem("token");
    let chart;
    let exchangeRate = 1;
    let currency = "EUR";

    if (!token) {
      alert("Accès refusé. Veuillez vous connecter.");
      window.location.href = "index.html";
    }

    document.getElementById("currencySelect").addEventListener("change", async (e) => {
      currency = e.target.value;
      await loadExchangeRate();
      renderPortfolioPage();
    });

    async function loadExchangeRate() {
      if (currency === "EUR") {
        exchangeRate = 1;
        updateCurrencyLabels();
        return;
      }
      try {
        const res = await fetch(`https://api.exchangerate.host/latest?base=EUR&symbols=USD`);
        const data = await res.json();
        exchangeRate = data.rates.USD;
        updateCurrencyLabels();
      } catch {
        alert("Impossible de récupérer le taux de change");
      }
    }

    function updateCurrencyLabels() {
      document.querySelectorAll("#currencyLabel, #currencyLabel2").forEach(el => el.textContent = currency === "EUR" ? "€" : "$");
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    document.getElementById("cryptoForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const ticker = document.getElementById("ticker").value.trim().toUpperCase();
      const amount = parseFloat(document.getElementById("amount").value);
      const messageEl = document.getElementById("message");
      try {
        const res = await fetch(`${backendUrl}/portfolio`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ ticker, amount })
        });
        const data = await res.json();
        if (res.ok) { messageEl.textContent = "Cryptomonnaie ajoutée !"; messageEl.className = "message"; renderPortfolioPage(); }
        else { messageEl.textContent = data.message || "Erreur lors de l'ajout."; messageEl.className = "message error"; }
      } catch (err) {
        messageEl.textContent = "Erreur réseau : " + err.message;
        messageEl.className = "message error";
      }
    });

    async function deleteCrypto(ticker) {
      if (!confirm(`Supprimer ${ticker} ?`)) return;
      try {
        const res = await fetch(`${backendUrl}/portfolio/${ticker}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (res.ok) renderPortfolioPage();
        else alert(data.message || "Erreur suppression");
      } catch (err) {
        alert("Erreur réseau : " + err.message);
      }
    }

    async function renderPortfolioPage() {
      await loadExchangeRate();
      const tableBody = document.querySelector("#portfolioTable tbody");
      tableBody.innerHTML = "<tr><td colspan='5'>Chargement...</td></tr>";
      try {
        const res = await fetch(`${backendUrl}/portfolio`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok) {
          tableBody.innerHTML = "";
          document.getElementById("message").textContent = data.message || "Erreur";
          document.getElementById("message").className = "message error";
          return;
        }
        const port = data.portfolio || [];
        tableBody.innerHTML = "";
        const chartData = [];
        if (port.length === 0) {
          tableBody.innerHTML = "<tr><td colspan='5'>Aucun actif</td></tr>";
        } else {
          port.forEach(item => {
            const price = item.price * exchangeRate;
            const total = item.total * exchangeRate;
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${item.ticker}</td>
              <td>${item.amount}</td>
              <td>${price.toFixed(2)}</td>
              <td>${total.toFixed(2)}</td>
              <td><button onclick="deleteCrypto('${item.ticker}')">Supprimer</button></td>
            `;
            tableBody.appendChild(row);
            chartData.push({ label: item.ticker, value: total });
          });
        }
        renderChart(chartData);
      } catch (err) {
        document.getElementById("message").textContent = "Erreur réseau : " + err.message;
        document.getElementById("message").className = "message error";
      }
    }

    function renderChart(data) {
      const ctx = document.getElementById("portfolioChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: data.map(d => d.label),
          datasets: [{
            data: data.map(d => d.value),
            backgroundColor: ["#00bcd4", "#4caf50", "#ff9800", "#e91e63", "#9c27b0"]
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "#fff" } } }
        }
      });
    }

    // Initialisation
    renderPortfolioPage();
  </script>
</body>
</html>
